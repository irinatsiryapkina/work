CREATE OR REPLACE VIEW "rotus"."landfill_size_summary" AS (
  WITH "lmop_landfill_data"       AS (SELECT "landfill_id"
                                           , "state_abbr"
                                           , "landfill_open_year"
                                           , "landfill_closure_year"
                                           , "landfill_current_status"
                                           , "landfill_design_capacity_tons"
                                           , "landfill_design_area_acres"
                                           , "landfill_design_depth_feet"
                                           , "landfill_current_area_acres"
                                           , "landfill_current_depth_feet"
                                           , "waste_in_place_tons"
                                           , "waste_in_place_year"
                                           , "lfg_generated_mmscfd"
                                           , "lfg_collection_system_in_place"
                                           , "lfg_collected_mmscfd"
                                           , "lfg_collected_year"
                                           , "lfg_percent_methane"
                                           , "flares_in_place"
                                           , "lfg_flared_mmscfd"
                                           , "lfg_flared_year"
                                           , "gas_collection_system_comments"
                                      FROM "epa"."lmop_landfill_data"
                                      WHERE "lmop_landfill_data"."state_abbr" != 'CA'::TEXT),
       "lmop_data"                AS (SELECT "landfill_id"
                                           , "project_id"
                                           , "state_abbr"
                                           , "lfg_collection_system_in_place"
                                           , "lfg_collected_mmscfd"
                                           , "lfg_flared_mmscfd"
                                           , "project_current_status"
                                           , "project_start_date"
                                           , "project_shutdown_date"
                                           , "lfg_energy_project_type"
                                           , "project_type_category"
                                           , "project_capacity_mw"
                                           , "project_lfg_inflow_mmscfd"
                                      FROM "epa"."lmop_data"
                                      WHERE "lmop_data"."state_abbr" != 'CA'::TEXT),
       "landfill_size_classifier" AS (SELECT "landfill_id"
                                           , ("landfill_design_area_acres"    * (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'acre'       AND "to_unit" = 'square feet') * "landfill_design_depth_feet" / (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'cubic meter' AND "to_unit" = 'cubic feet' )) >= '2500000'::NUMERIC AS "large_volume"
                                           , ("landfill_design_capacity_tons" / (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'metric ton' AND "to_unit" = 'US ton')    )                                                                                                                                                >= '2500000'::NUMERIC AS "large_capacity"
                                           , ("waste_in_place_tons"           / (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'metric ton' AND "to_unit" = 'US ton')    )                                                                                                                                                >= '2500000'::NUMERIC AS "large_waste_in_place"
                                           , ("landfill_design_area_acres"    * (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'acre'       AND "to_unit" = 'square feet') * "landfill_design_depth_feet" / (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'cubic meter' AND "to_unit" = 'cubic feet' )) <  '2500000'::NUMERIC AS "small_volume"
                                           , ("landfill_design_capacity_tons" / (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'metric ton' AND "to_unit" = 'US ton')    )                                                                                                                                                <  '2500000'::NUMERIC AS "small_capacity"
                                           , ("waste_in_place_tons"           / (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'metric ton' AND "to_unit" = 'US ton')    )                                                                                                                                                <  '2500000'::NUMERIC AS "small_waste_in_place"
                                           , "landfill_design_area_acres"     IS NULL OR "landfill_design_depth_feet" IS NULL                                                                                                                                                                                                                                    AS "null_volume"
                                           , "landfill_design_capacity_tons"  IS NULL                                                                                                                                                                                                                                                                            AS "null_capacity"
                                           , "waste_in_place_tons"            IS NULL                                                                                                                                                                                                                                                                            AS "null_waste_in_place"
                                      FROM "lmop_landfill_data"),
       "project_landfill_summary" AS (SELECT "a"."landfill_id"
                                           , "a"."landfill_design_area_acres"
                                           , "a"."landfill_design_depth_feet"
                                           , "a"."landfill_design_capacity_tons"
                                           , "a"."landfill_current_status"
                                           , "b"."null_volume"
                                           , "b"."null_capacity"
                                           , "b"."large_volume"
                                           , "b"."large_capacity"
                                           , "b"."small_volume"
                                           , "b"."small_capacity"
                                           , "c"."project_type_category"
                                           , CASE WHEN "b"."null_volume"  IS TRUE AND "b"."null_capacity"  IS TRUE THEN NULL::TEXT
                                                  WHEN "b"."large_volume" IS TRUE OR  "b"."large_capacity" IS TRUE THEN 'large'::TEXT
                                                  ELSE 'small'::TEXT
                                             END AS "landfill_design_size_category"
                                           , "a"."waste_in_place_tons"
                                      FROM      "lmop_landfill_data"       "a"
                                      LEFT JOIN "landfill_size_classifier" "b" ON "a"."landfill_id" = "b"."landfill_id"
                                      LEFT JOIN "lmop_data"                "c" ON "c"."landfill_id" = "a"."landfill_id"),
       "landfill_ids"             AS (SELECT DISTINCT ON ("landfill_id") * FROM "project_landfill_summary")
  SELECT ROUND(AVG("a"."waste_in_place_tons"           * (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'US ton'     AND "to_unit" = 'metric ton' )), 2) AS "AVG_waste_in_place_tonnes"
       , ROUND(AVG("a"."landfill_design_capacity_tons" / (SELECT "factor" FROM "admin"."conversions" WHERE "from_unit" = 'metric ton' AND "to_unit" = 'US ton')     ), 2) AS "AVG_capacity_tonnes"
       , ROUND(AVG("a"."waste_in_place_tons"           / "a"."landfill_design_capacity_tons"),                                                                         2) AS "AVG_percent_capacity"
       , "a"."landfill_current_status"
       , "a"."landfill_design_size_category"
  FROM "landfill_ids" a
  WHERE "a"."landfill_design_size_category" IS NOT NULL
  GROUP BY "a"."landfill_design_size_category"
         , "a"."landfill_current_status"
  ORDER BY "a"."landfill_current_status"
         , "a"."landfill_design_size_category"
);

COMMENT ON VIEW "rotus"."landfill_size_summary" IS '';
